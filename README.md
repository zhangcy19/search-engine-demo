# 搜索引擎大作业—图片搜索引擎DEMO

张朝阳 2019010065



### 1. 问题描述

目标是构建一个图片搜索引擎demo。使用的数据集是[谷歌开放图片数据](https://github.com/cvdfoundation/open-images-dataset)，包括图片数据（选取了其中的part-6（约31G））和标记数据。构建搜索引擎包括前端与后端两个部分，前端要实现用户界面与交互，后端要实现查询处理与信息检索。

### 2. 实现模块

#### 2.1.前端

前端使用了React框架，构建工具用的是create-my-app，前端项目结构如下：（高亮的是我自己写的组件代码）

|-- front_end
    |-- README.md（create-my-app的使用说明）
    |-- package-lock.json（记录引用包的json文件，锁定）
    |-- package.json（记录引用包的json文件）
    |-- build（构建后的项目根目录，可以直接放到服务器上跑）
    |-- public（构建前的项目根目录，只能在create-my-app环境下跑）
    |   |-- favicon.ico
    |   |-- index.html
    |   |-- logo192.png
    |   |-- logo512.png
    |   |-- manifest.json（移动端适配优化的文件）
    |   |-- robots.txt（君子协议）
    |-- src（项目源代码）
        |-- ==App.css==
        |-- ==App.js==（主组件，负责渲染子组件）
        |-- App.test.js
        |-- error.svg
        |-- index.css
        |-- index.js
        |-- logo.svg
        |-- reportWebVitals.js（debug用）
        |-- search.svg
        |-- setupTests.js（debug用）
        |-- ==component==（核心代码）
            |-- ==cover.css==
            |-- ==cover.js==（标题与logo的动态展示）
            |-- ==error.css==
            |-- ==error.js==（错误信息提示）
            |-- ==result.css==
            |-- ==result.js==（高级查询与结果展示）
            |-- ==search.css==
            |-- ==search.js==（一般查询）

#### 2.2.后端

|-- back_end
    |   |-- dataprocess_daopai.py （构建倒排索引）
    |   |-- dataprocess_list.py（根据倒排表构建候选词库）
    |   |-- dataprocess_zhengpai.py（转换标记信息格式，构建正排索引）
    |   |-- importdata.php（将正排表与倒排表导入mysql数据库）
    |   |-- translate.py（在提供的英文关键词基础上增加中文翻译）
    |   |-- query.php（处理查询，分词与检索）


### 3. 关键功能

#### 3.1.用户界面

第一次开发前端，选择的是React框架，这个框架的核心思想可以概括为组件化，通过构建虚拟DOM实现每个组件之间单独渲染互不干扰，从而可以获得较好的性能。

组件逻辑为:

```html
<App> <!--父组件-->
  <Cover/><!--子组件-->
  <Search/><!--子组件-->
	<Result/><!--子组件-->
 <App/>
```

父组件`<App/>`实现了：1.组件切换与状态控制；2.子组件之间的信息流动（React信息一般只能从下往上或从上往下流动，这也是官方推荐写法）

子组件`<Cover/>`实现了：logo（动态展示）与标题

子组件`<Search/>`实现了：logo与标题（过渡变换），输入框（动态展开），候选词列表（动态更新）

子组件`<Result/>`实现了：logo（过渡变换），输入框（动态展开），高级搜索框（变换动画），结果展示（悬浮动画）

#### 3.2.图片检索

先是用比较熟悉的python处理了一下原数据，包括翻译英文、去除无关信息、转换低效信息和构建正倒排表，然后用php和mysql实现了后端的查询处理程序，包括分词、去除停用词、中/英文检索、排序取前n项

关于图片的rank与排序问题：

1. 图片比较特殊，无法直接使用常见的BM25等算法，我是利用标记信息中的Xmin、Xmax、Ymin与Ymax四个参数（框选标记主体在图片中的位置信息），算出了全部标记主体在图片中占据的比例，以此作为该关键词下该图片的rank值
2. 对于多关键词查询，如果简单将所有关键词的rank加和，可能会出现一些图片由于某一个关键词权重非常大而排名靠前，但对于用户来说更希望能同时出现所有关键词，因此我对一张图片出现的第二个及以后的关键词的rank给了更大的权重（*1.5），奖励能够出现多个关键词的图片

#### 3.3.额外功能

候选词推荐：根据用户输入动态提供候选词

尺寸筛选：可以筛选图片的横版/竖版/方形

跨语言搜索：支持中文搜索、英文搜索、中英文搜索

移动端兼容：前端系统地使用了flex（弹性盒子）布局，兼容支持横版设备与竖版设备

### 4. 测试结果与样例分析

#### 4.1.查询样例集合构建

| 序号 |      查询词      |  查询词类型*   | 热门程度 |
| :--: | :--------------: | :------------: | :------: |
|  1   |       dog        |  单个英文查询  |    8     |
|  2   |      oyster      |  单个英文查询  |    2     |
|  3   |        猫        |  单个中文查询  |    8     |
|  4   |     萨克斯管     |  单个中文查询  |    1     |
|  5   | dog on the grass |  多个英文查询  |    6     |
|  6   | woman with dress |  多个英文查询  |    5     |
|  7   |    西装 男人     |  多个中文查询  |    3     |
|  8   |    蛋糕 面包     |  多个中文查询  |    6     |
|  9   |      狗 cat      | 中英文混合查询 |    3     |
|  10  |    西瓜 juice    | 中英文混合查询 |    5     |

*图片查询均是为了查找具有查询词特征的图片，不存在导航类和事务类，因此改用查询词本身的类别区分

#### 4.2.相关性结果

| 序号 | 相关性序列 |
| :--: | :--------: |
|  1   | 1111111111 |
|  2   | 1111111111 |
|  3   | 1111111111 |
|  4   | 1111111011 |
|  5   | 1001000101 |
|  6   | 1000000000 |
|  7   | 0000101000 |
|  8   | 1011111111 |
|  9   | 1110111001 |
|  10  | 1011111101 |

#### 4.3.评价指标计算

|      类型      |  AP  |  PR  | P@10 | success@10 |
| :------------: | :--: | :--: | :--: | :--------: |
|  单个英文查询  | 1.00 | 1.00 | 1.00 |    1.00    |
|  单个中文查询  | 0.99 | 0.95 | 1.00 |    0.95    |
|  多个英文查询  | 0.79 | 0.25 | 1.00 |    0.25    |
|  多个中文查询  | 0.54 | 0.55 | 0.60 |    0.55    |
| 中英文混合查询 | 0.85 | 0.75 | 1.00 |    0.75    |

#### 4.4.评价与分析

对于单个关键词的查询准确率比较高，而对于多个关键词的查询准确率则比较低。对于多个关键词的查询，准确率低的原因主要有两个：

1. 我使用的数据库的图片数量有限，多关键词取交集很可能造成结果过少，因此我实际上是取的并集，然后通过rank值进行排序
2. 我为了优化性能（不优化的话我的电脑查询一次时长就会超过30s）将倒排表的词项数限制为50个，也就是说每个倒排的关键词对应的图片索引列表只剩下rank值最高的50个，对rank值取前50的好处是对于单个关键词查询可以得到主体占比最大的图片，但相应的就很难再出现其他主体了，因此多关键词准确率会下降

### 5. 参考资料与代码

使用了部分React框架代码，参考了一些css的样式与配色（来源网络），其余均为原创

